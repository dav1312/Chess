<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Generate a reusable Lichess challenge link with your custom settings to share with any opponent.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lichess Challenge Link Creator</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    colors: {
                        lichess: {
                            bg: '#f5f5f5',
                            'dark-bg': '#161512',
                            card: '#ffffff',
                            'dark-card': '#262421',
                            text: '#333333',
                            'dark-text': '#bababa',
                            secondary: '#666666',
                            'dark-secondary': '#8c8c8c',
                            border: '#e0e0e0',
                            'dark-border': '#383838',
                            accent: '#3692e7',
                            'accent-hover': '#2d7bc2',
                            'accent-hover-dark': '#4aa0ec',
                            input: '#ffffff',
                            'dark-input': '#302e2c',
                            success: '#629924'
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        /* Dynamic state classes toggled by JS */
        .toggle-option.active {
            @apply bg-lichess-accent text-white font-medium;
        }

        .toast.show {
            @apply opacity-100;
        }

        /* Patron Icon Mask */
        .patron-icon {
            --wing: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" viewBox="0 0 183 186" version="1.1"><g><path d="M180.64 171.09c.78-3.65 1.02-5.48 1.43-10.61.49-6.18.28-12.75-.64-20.01-3.07-24.1-15.72-44.25-37.29-59.37-11.06-7.75-21.59-12.91-44.24-21.68-40.47-15.67-55.3-22.92-73.42-35.95-8.03-5.77-13.64-10.63-20.28-17.57-2.97-3.11-5.52-5.65-5.66-5.65-.5 0-.24 12.45.36 17.14 2.6 20.35 10.66 35.18 21.51 48.3 8.09 9.78 21.8 19.04 43.76 28.56 7.68 3.33 16.14 6.62 36.12 12.06 20.01 5.44 24.09 6.94 34.53 12.64 14.01 7.66 24.69 17.97 33.61 32.47 2.95 4.79 6.73 12.55 8.46 17.37 1.13 3.15 1.48 3.61 1.76 2.3zM108.28 184.59c4.45-.78 7-1.49 15.43-4.28 7.99-2.65 13.86-4.2 18.6-4.92 4.02-.61 11.38-.29 15.53.68 3.79.88 10.01 3.54 13.4 5.72 1.45.93 2.69 1.64 2.75 1.57.24-.26-3.14-8.67-4.89-12.15-4.65-9.24-8.46-14.9-14.63-21.73-6.96-7.71-13.04-12.45-22.43-17.49-11.11-5.96-18.02-8.11-44.65-13.89-36.78-7.99-51.19-13.81-70.13-28.31-.78-.6-.8-.57-.53.85 1.39 7.27 6.36 19.56 11.52 28.5 8.44 14.62 19.68 22.69 31.69 26.21 8.02 2.35 25.92 5.12 32.65 5.47l28.68 2.58-3.88 2.57c-2.64 1.74-10.71 4.82-15.59 5.74-15.48 2.92-21.81.4-33.03-.15l-5.9-.29 1.32 2.07c1.89 2.96 7.96 9.58 11.24 12.27 4.99 4.09 11.28 7.26 17.05 8.6 4.01.93 11.62 1.12 15.77.39z" /></g></svg>');
            margin-right: 4px;
            height: 17px;
            width: 17px;
            mask-image: var(--wing);
            mask-size: contain;
            mask-repeat: no-repeat;
            mask-position: center;
            -webkit-mask-image: var(--wing);
            -webkit-mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            -webkit-mask-position: center;
        }

        /* Utility overrides */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-lichess-bg dark:bg-lichess-dark-bg text-lichess-text dark:text-lichess-dark-text flex justify-center items-center min-h-screen transition-colors duration-300 p-5 font-sans">

<div class="bg-lichess-card dark:bg-lichess-dark-card w-full max-w-[500px] p-8 rounded-lg shadow-lg">
    <h1 class="text-2xl mb-6 text-center font-light">Create Lichess Challenge Link</h1>
    <p class="text-sm text-center text-lichess-secondary dark:text-lichess-dark-secondary mb-6">
        Generate a reusable challenge link with your custom settings to share with any opponent.
    </p>

    <!-- Opponent -->
    <div class="mb-5 relative">
        <label for="username" class="block mb-2 text-sm text-lichess-secondary dark:text-lichess-dark-secondary">Username</label>
        <input type="text" id="username" placeholder="Search player..." autocomplete="off"
               class="w-full p-2.5 rounded border border-lichess-border dark:border-lichess-dark-border bg-lichess-input dark:bg-lichess-dark-input text-lichess-text dark:text-lichess-dark-text text-base outline-none transition-colors focus:border-lichess-accent">
        <div id="autocomplete-list" class="absolute top-full left-0 right-0 bg-lichess-card dark:bg-lichess-dark-card border border-lichess-border dark:border-lichess-dark-border border-t-0 rounded-b max-h-[200px] overflow-y-auto z-10 shadow-md hidden"></div>
    </div>

    <!-- Variant -->
    <div class="mb-5 relative">
        <label for="variant" class="block mb-2 text-sm text-lichess-secondary dark:text-lichess-dark-secondary">Variant</label>
        <select id="variant" class="w-full p-2.5 rounded border border-lichess-border dark:border-lichess-dark-border bg-lichess-input dark:bg-lichess-dark-input text-lichess-text dark:text-lichess-dark-text text-base outline-none transition-colors focus:border-lichess-accent">
            <option value="any">Any</option>
            <option value="standard">Standard</option>
            <option value="crazyhouse">Crazyhouse</option>
            <option value="chess960">Chess960</option>
            <option value="kingOfTheHill">King of the Hill</option>
            <option value="threeCheck">Three-check</option>
            <option value="antichess">Antichess</option>
            <option value="atomic">Atomic</option>
            <option value="horde">Horde</option>
            <option value="racingKings">Racing Kings</option>
            <option value="fromPosition">From Position (FEN)</option>
        </select>
    </div>

    <!-- FEN (Hidden by default) -->
    <div class="mb-5 relative hidden" id="fen-group">
        <label for="fen" class="block mb-2 text-sm text-lichess-secondary dark:text-lichess-dark-secondary">FEN String</label>
        <input type="text" id="fen" placeholder="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"
               class="w-full p-2.5 rounded border border-lichess-border dark:border-lichess-dark-border bg-lichess-input dark:bg-lichess-dark-input text-lichess-text dark:text-lichess-dark-text text-base outline-none transition-colors focus:border-lichess-accent">
    </div>

    <!-- Mode (Casual/Rated) -->
    <div class="mb-5 relative">
        <label class="block mb-2 text-sm text-lichess-secondary dark:text-lichess-dark-secondary">Mode</label>
        <div class="flex flex-wrap gap-2.5 bg-lichess-input dark:bg-lichess-dark-input p-1 rounded-md border border-lichess-border dark:border-lichess-dark-border" id="mode-toggle">
            <div class="toggle-option flex-1 text-center p-2 cursor-pointer rounded text-sm transition-all select-none active" data-mode="any" onclick="setMode('any', this)">Any</div>
            <div class="toggle-option flex-1 text-center p-2 cursor-pointer rounded text-sm transition-all select-none" data-mode="casual" onclick="setMode('casual', this)">Casual</div>
            <div class="toggle-option flex-1 text-center p-2 cursor-pointer rounded text-sm transition-all select-none" data-mode="rated" onclick="setMode('rated', this)">Rated</div>
        </div>
    </div>

    <!-- Time Control Type -->
    <div class="mb-5 relative">
        <label class="block mb-2 text-sm text-lichess-secondary dark:text-lichess-dark-secondary">Time Control</label>
        <div class="flex flex-wrap gap-2.5 bg-lichess-input dark:bg-lichess-dark-input p-1 rounded-md border border-lichess-border dark:border-lichess-dark-border">
            <div class="toggle-option flex-1 text-center p-2 cursor-pointer rounded text-sm transition-all select-none active" onclick="setTimeType('any', this)">Any</div>
            <div class="toggle-option flex-1 text-center p-2 cursor-pointer rounded text-sm transition-all select-none" onclick="setTimeType('realTime', this)">Real Time</div>
            <div class="toggle-option flex-1 text-center p-2 cursor-pointer rounded text-sm transition-all select-none" onclick="setTimeType('correspondence', this)">Correspondence</div>
            <div class="toggle-option flex-1 text-center p-2 cursor-pointer rounded text-sm transition-all select-none" onclick="setTimeType('unlimited', this)">Unlimited</div>
        </div>
    </div>

    <!-- Time Inputs: Real Time -->
    <div id="realtime-inputs" class="mb-5 relative hidden">
        <label class="flex items-center gap-2 mb-3 text-sm text-lichess-secondary dark:text-lichess-dark-secondary cursor-pointer">
            <input type="checkbox" id="rt-any" class="accent-lichess-accent w-4 h-4">
            <span>Any time limit</span>
        </label>
        <div class="flex gap-2.5" id="rt-values">
            <div class="flex-1">
                <label class="block mb-2 text-sm text-lichess-secondary dark:text-lichess-dark-secondary">Minutes</label>
                <input type="number" id="minutes" value="10" min="0" max="180"
                       class="w-full p-2.5 rounded border border-lichess-border dark:border-lichess-dark-border bg-lichess-input dark:bg-lichess-dark-input text-lichess-text dark:text-lichess-dark-text text-base outline-none transition-colors focus:border-lichess-accent">
            </div>
            <div class="flex-1">
                <label class="block mb-2 text-sm text-lichess-secondary dark:text-lichess-dark-secondary">Increment (sec)</label>
                <input type="number" id="increment" value="0" min="0" max="180"
                       class="w-full p-2.5 rounded border border-lichess-border dark:border-lichess-dark-border bg-lichess-input dark:bg-lichess-dark-input text-lichess-text dark:text-lichess-dark-text text-base outline-none transition-colors focus:border-lichess-accent">
            </div>
        </div>
    </div>

    <!-- Time Inputs: Correspondence -->
    <div id="correspondence-inputs" class="mb-5 relative hidden">
        <label class="flex items-center gap-2 mb-3 text-sm text-lichess-secondary dark:text-lichess-dark-secondary cursor-pointer">
            <input type="checkbox" id="c-any" class="accent-lichess-accent w-4 h-4">
            <span>Any days per turn</span>
        </label>
        <div id="c-values">
            <label class="block mb-2 text-sm text-lichess-secondary dark:text-lichess-dark-secondary">Days per turn</label>
            <input type="number" id="days" value="1" min="1" max="14"
                   class="w-full p-2.5 rounded border border-lichess-border dark:border-lichess-dark-border bg-lichess-input dark:bg-lichess-dark-input text-lichess-text dark:text-lichess-dark-text text-base outline-none transition-colors focus:border-lichess-accent">
        </div>
    </div>

    <!-- Color -->
    <div class="mb-5 relative">
        <label class="block mb-2 text-sm text-lichess-secondary dark:text-lichess-dark-secondary">Color</label>
        <div class="flex flex-wrap gap-2.5 bg-lichess-input dark:bg-lichess-dark-input p-1 rounded-md border border-lichess-border dark:border-lichess-dark-border">
            <div class="toggle-option flex-1 text-center p-2 cursor-pointer rounded text-sm transition-all select-none active" onclick="setColor('any', this)">Any</div>
            <div class="toggle-option flex-1 text-center p-2 cursor-pointer rounded text-sm transition-all select-none" onclick="setColor('random', this)">Random</div>
            <div class="toggle-option flex-1 text-center p-2 cursor-pointer rounded text-sm transition-all select-none" onclick="setColor('white', this)">White</div>
            <div class="toggle-option flex-1 text-center p-2 cursor-pointer rounded text-sm transition-all select-none" onclick="setColor('black', this)">Black</div>
        </div>
    </div>

    <!-- Result -->
    <div class="mt-8">
        <label class="block mb-2 text-sm text-lichess-secondary dark:text-lichess-dark-secondary">Challenge Link</label>
        <div class="flex bg-lichess-input dark:bg-lichess-dark-input border border-lichess-border dark:border-lichess-dark-border rounded overflow-hidden cursor-pointer transition-colors hover:border-lichess-accent" id="copy-target">
            <div class="flex-1 p-3 font-mono whitespace-nowrap overflow-hidden text-ellipsis text-lichess-text dark:text-lichess-dark-text text-sm" id="result-link">https://lichess.org/</div>
            <button class="px-5 bg-lichess-accent text-white border-none cursor-pointer flex items-center justify-center font-medium hover:bg-lichess-accent-hover dark:hover:bg-lichess-accent-hover-dark">Copy</button>
        </div>
    </div>
</div>

<div class="toast fixed bottom-5 left-1/2 -translate-x-1/2 bg-lichess-success text-white py-2.5 px-5 rounded-[20px] text-sm opacity-0 transition-opacity duration-300 pointer-events-none" id="toast">Link copied to clipboard!</div>

<script>
    // State
    const state = {
        username: '',
        variant: 'any',
        fen: '',
        mode: 'any', // any | casual | rated
        timeType: 'any', // any | realTime | correspondence | unlimited
        minutes: 10,
        increment: 0,
        days: 1,
        rtAny: false,
        corrAny: false,
        color: 'any' // white | black | random | any
    };

    const patronColors = [
        "hsl(72, 38%, 51.6%)",
        "hsl(108, 38%, 56.7%)",
        "hsl(144, 49%, 51.2%)",
        "hsl(180, 52%, 48.1%)",
        "hsl(216, 89%, 72.2%)",
        "hsl(252, 83%, 79.1%)",
        "hsl(288, 81%, 74.5%)",
        "hsl(324, 76%, 73.4%)",
        "hsl(0, 90%, 75.7%)",
        "hsl(36, 74%, 54.2%)"
    ];

    // DOM Elements
    const els = {
        username: document.getElementById('username'),
        acList: document.getElementById('autocomplete-list'),
        variant: document.getElementById('variant'),
        fenGroup: document.getElementById('fen-group'),
        fen: document.getElementById('fen'),
        realTimeInputs: document.getElementById('realtime-inputs'),
        rtValues: document.getElementById('rt-values'),
        rtAnyCheckbox: document.getElementById('rt-any'),
        corrInputs: document.getElementById('correspondence-inputs'),
        corrValues: document.getElementById('c-values'),
        corrAnyCheckbox: document.getElementById('c-any'),
        minutes: document.getElementById('minutes'),
        increment: document.getElementById('increment'),
        days: document.getElementById('days'),
        linkText: document.getElementById('result-link'),
        copyTarget: document.getElementById('copy-target'),
        toast: document.getElementById('toast'),
        modeToggle: document.getElementById('mode-toggle')
    };

    // --- Logic ---

    function generateLink() {
        const baseUrl = 'https://lichess.org/';
        const params = new URLSearchParams();

        if (state.username) params.append('user', state.username);

        if (state.variant !== 'any') {
            if (state.variant === 'fromPosition' && state.fen) {
                params.append('fen', state.fen);
            } else if (state.variant) {
                params.append('variant', state.variant);
            }
        }

        if (state.timeType === 'realTime') {
            if (state.rtAny) {
                params.append('time', 'realTime');
            } else {
                params.append('minutesPerSide', state.minutes);
                params.append('increment', state.increment);
            }
        } else if (state.timeType === 'correspondence') {
            if (state.corrAny) {
                params.append('time', 'correspondence');
            } else {
                params.append('days', state.days);
            }
        } else if (state.timeType === 'unlimited') {
            params.append('time', 'unlimited');
        }

        if (state.mode !== 'any') {
            if (state.mode) params.append('gameMode', state.mode);
        }

        if (state.color !== 'any') {
            params.append('color', state.color);
        }

        // The lobby controller looks for #friend to trigger the specific logic
        let finalUrl = `${baseUrl}?${params.toString()}#friend`;

        // Clean up empty ? if no params (unlikely)
        if (finalUrl.includes('?#')) finalUrl = finalUrl.replace('?#', '#');

        els.linkText.textContent = finalUrl;
    }

    // --- Event Listeners & UI Helpers ---

    function setMode(mode, element) {
        if (state.timeType === 'unlimited' && mode === 'rated') return;
        state.mode = mode;
        updateToggleUI(element);
        generateLink();
    }

    function setTimeType(type, element) {
        state.timeType = type;
        updateToggleUI(element);

        // Visibility
        els.realTimeInputs.classList.add('hidden');
        els.corrInputs.classList.add('hidden');

        if (type === 'realTime') els.realTimeInputs.classList.remove('hidden');
        if (type === 'correspondence') els.corrInputs.classList.remove('hidden');

        // Logic check: Unlimited is always casual in Lichess. Set to "any" to not append anything to link.
        if (type === 'unlimited') {
           state.mode = 'any';
           const anyBtn = els.modeToggle.querySelector('[data-mode="any"]');
           updateToggleUI(anyBtn);
        }

        generateLink();
    }

    function setColor(color, element) {
        state.color = color;
        updateToggleUI(element);
        generateLink();
    }

    function updateToggleUI(activeElement) {
        const parent = activeElement.parentElement;
        parent.querySelectorAll('.toggle-option').forEach(el => el.classList.remove('active'));
        activeElement.classList.add('active');
    }

    // Input Listeners
    els.variant.addEventListener('change', (e) => {
        state.variant = e.target.value;
        if (state.variant === 'fromPosition') els.fenGroup.classList.remove('hidden');
        else els.fenGroup.classList.add('hidden');
        generateLink();
    });

    els.fen.addEventListener('input', (e) => { state.fen = e.target.value.trim(); generateLink(); });
    els.minutes.addEventListener('input', (e) => {
        state.minutes = Math.min(180, e.target.value);
        generateLink();
    });
    els.increment.addEventListener('input', (e) => {
        state.increment = Math.min(180, e.target.value);
        generateLink();
    });
    els.days.addEventListener('input', (e) => { state.days = e.target.value; generateLink(); });

    els.rtAnyCheckbox.addEventListener('change', (e) => {
        state.rtAny = e.target.checked;
        if (state.rtAny) els.rtValues.classList.add('opacity-50', 'pointer-events-none');
        else els.rtValues.classList.remove('opacity-50', 'pointer-events-none');
        generateLink();
    });

    els.corrAnyCheckbox.addEventListener('change', (e) => {
        state.corrAny = e.target.checked;
        if (state.corrAny) els.corrValues.classList.add('opacity-50', 'pointer-events-none');
        else els.corrValues.classList.remove('opacity-50', 'pointer-events-none');
        generateLink();
    });

    // --- Autocomplete Logic ---
    let typingTimer;

    els.username.addEventListener('input', (e) => {
        const val = e.target.value.trim();
        state.username = val;
        generateLink();

        clearTimeout(typingTimer);
        els.acList.innerHTML = '';
        els.acList.style.display = 'none';

        if (val.length >= 3) {
            typingTimer = setTimeout(() => fetchUsers(val), 250);
        }
    });

    // Hide autocomplete when clicking outside
    document.addEventListener('click', (e) => {
        if (!els.username.contains(e.target) && !els.acList.contains(e.target)) {
            els.acList.style.display = 'none';
        }
    });

    async function fetchUsers(term) {
        try {
            const response = await fetch(`https://lichess.org/api/player/autocomplete?term=${term}&object=1`);
            if (!response.ok) return;
            const data = await response.json();

            els.acList.innerHTML = '';

            if (data.result && data.result.length > 0) {
                els.acList.style.display = 'block';
                data.result.forEach(user => {
                    const div = document.createElement('div');
                    // Styling for autocomplete items
                    div.className = 'autocomplete-item p-2.5 cursor-pointer flex items-center hover:bg-lichess-bg dark:hover:bg-lichess-dark-bg';

                    let flairHtml = '';
                    if (user.patron) {
                        const color = patronColors[(user.patronColor || 1) - 1] || patronColors[0];
                        flairHtml = `<span class="patron-icon" style="background-color: ${color}"></span>`;
                    }

                    // Add Title if exists
                    let nameDisplay = user.name;
                    if(user.title) nameDisplay = `<span class="text-lichess-accent font-bold mr-1">${user.title}</span>` + nameDisplay;

                    div.innerHTML = `${flairHtml}<span>${nameDisplay}</span>`;

                    div.addEventListener('click', () => {
                        els.username.value = user.name;
                        state.username = user.name;
                        els.acList.style.display = 'none';
                        generateLink();
                    });
                    els.acList.appendChild(div);
                });
            }
        } catch (err) {
            console.error("Autocomplete failed:", err);
        }
    }

    // Copy Functionality
    els.copyTarget.addEventListener('click', () => {
        const text = els.linkText.textContent;
        navigator.clipboard.writeText(text).then(() => {
            els.toast.classList.add('show');
            setTimeout(() => els.toast.classList.remove('show'), 2000);
        });
    });

    // Initialize
    generateLink();

</script>

</body>
</html>
